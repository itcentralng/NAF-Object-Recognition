<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Test & Arduino Monitor - NAF Object Recognition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .control-group {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.reset { background-color: #dc3545; }
        button.reset:hover { background-color: #c82333; }
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .current-state {
            background-color: #e7f3ff;
            border: 1px solid #b6d7ff;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NAF Object Recognition - Socket.IO Test & Arduino Monitor</h1>
        
        <div id="connectionStatus" class="status disconnected">
            Disconnected
        </div>

        <div class="current-state">
            <h3>Current State</h3>
            <p><strong>Picked Object:</strong> <span id="currentObject">None</span></p>
            <p><strong>Dropped Year:</strong> <span id="currentYear">None</span></p>
            <p><strong>Current State:</strong> <span id="currentState">main</span></p>
            <p><strong>Arduino Status:</strong> <span id="arduinoStatus">Unknown</span></p>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Test Object Pick (UI Only)</h3>
                <select id="objectSelect">
                    <option value="">Select object...</option>
                    <option value="naf">NAF</option>
                    <option value="nafsfa">NAFSFA</option>
                    <option value="evol">EVOL</option>
                </select>
                <br>
                <button onclick="simulatePick()">Test Pick Object UI</button>
            </div>

            <div class="control-group">
                <h3>Test Year Drop (UI Only)</h3>
                <select id="yearSelect">
                    <option value="">Select year range...</option>
                    <option value="1962-1972">1962-1972</option>
                    <option value="1973-1982">1973-1982</option>
                    <option value="1983-1992">1983-1992</option>
                    <option value="1993-2002">1993-2002</option>
                    <option value="2003-2012">2003-2012</option>
                    <option value="2013-2022">2013-2022</option>
                    <option value="2023-2032">2023-2032</option>
                </select>
                <br>
                <button onclick="simulateDrop()">Test Drop Object UI</button>
            </div>
        </div>

        <div class="control-group" style="margin: 20px 0; text-align: center;">
            <h3>Arduino Controls</h3>
            <button onclick="getArduinoStatus()" style="background-color: #17a2b8;">Check Arduino Status</button>
            <button onclick="testArduinoConnection()" style="background-color: #28a745;">Test Arduino Connection</button>
        </div>

        <div class="control-group" style="margin: 20px 0; text-align: center;">
            <h3>Test Object Removal (UI Only)</h3>
            <button onclick="simulateObjectDrop()" style="background-color: #dc3545;">Test Remove Object UI</button>
        </div>

        <div class="control-group" style="margin: 20px 0; text-align: center;">
            <h3>Arduino Info</h3>
            <button onclick="simulateYearRangeNotDetected()" style="background-color: #ffc107; color: #000;">Year Range Detection Info</button>
        </div>

        <div class="control-group" style="margin: 20px 0; text-align: center;">
            <h3>Arduino Info</h3>
            <button onclick="simulateNoObjectDetected()" style="background-color: #6c757d;">Object Detection Info</button>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="reset" onclick="resetSimulation()">Reset UI State</button>
            <button onclick="getStatus()">Get System Status</button>
        </div>

        <div>
            <h3>Socket Events Log</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
            <h3>Instructions</h3>
            <ol>
                <li>Start the Python server: <code>python main.py</code></li>
                <li><strong>Arduino Mode:</strong> Connect Arduino with RFID reader and light sensors</li>
                <li><strong>Testing Mode:</strong> Use controls above to test UI behavior (server events only)</li>
                <li>Monitor the socket events in the log below</li>
                <li>Test the main application at <a href="http://127.0.0.1:5550" target="_blank">127.0.0.1:5550</a></li>
            </ol>
            <h4>Hardware Setup:</h4>
            <ul>
                <li>Light sensors on A0 (NAF), A1 (NAFSFA), A2 (Evolution)</li>
                <li>RFID reader on pins 9 (RST) and 10 (SS)</li>
                <li>Configure SERIAL_PORT in .env file (e.g., /dev/cu.usbmodem101, COM3)</li>
                <li>Year ranges: 1962-1972, 1973-1982, 1983-1992, 1993-2002, 2003-2012, 2013-2022, 2023-2032</li>
            </ul>
            <h4>Important Notes:</h4>
            <ul>
                <li><strong>Real System:</strong> All object picking and year detection is handled by Arduino hardware</li>
                <li><strong>Test Controls:</strong> Simulation buttons only test UI behavior, not server logic</li>
                <li><strong>Arduino Required:</strong> Full functionality requires connected Arduino with sensors</li>
            </ul>
        </div>
    </div>

    <script src="/assets/js/socket.io.min.js"></script>
    <script>
        const socket = io('http://127.0.0.1:5550');
        const log = document.getElementById('log');
        const connectionStatus = document.getElementById('connectionStatus');
        const currentObject = document.getElementById('currentObject');
        const currentYear = document.getElementById('currentYear');
        const currentState = document.getElementById('currentState');
        const arduinoStatus = document.getElementById('arduinoStatus');

        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${getColorForType(type)};">${message}</span>`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        function getColorForType(type) {
            switch(type) {
                case 'success': return '#28a745';
                case 'error': return '#dc3545';
                case 'warning': return '#ffc107';
                case 'socket': return '#007bff';
                default: return '#333';
            }
        }

        function updateCurrentState(object = null, year = null, state = null) {
            if (object !== null) currentObject.textContent = object || 'None';
            if (year !== null) currentYear.textContent = year || 'None';
            if (state !== null) currentState.textContent = state || 'main';
        }

        // Socket event handlers
        socket.on('connect', function() {
            connectionStatus.className = 'status connected';
            connectionStatus.textContent = 'Connected to server';
            addToLog('Connected to server', 'success');
            // Check Arduino status on connect
            getArduinoStatus();
        });

        socket.on('disconnect', function() {
            connectionStatus.className = 'status disconnected';
            connectionStatus.textContent = 'Disconnected from server';
            addToLog('Disconnected from server', 'error');
        });

        socket.on('status', function(data) {
            addToLog(`Server: ${data.msg}`, 'socket');
        });

        socket.on('error', function(data) {
            addToLog(`Error: ${data.msg}`, 'error');
        });

        socket.on('object_picked', function(data) {
            addToLog(`Object picked: ${data.object}`, 'success');
            updateCurrentState(data.object, null, 'section');
        });

        socket.on('year_dropped', function(data) {
            addToLog(`Year dropped: ${data.year} (Object: ${data.object})`, 'success');
            updateCurrentState(null, data.year, 'year-list');
        });

        socket.on('object_reset', function(data) {
            addToLog('Simulation reset', 'warning');
            updateCurrentState('None', 'None', 'main');
        });

        socket.on('system_status', function(data) {
            addToLog(`System Status - Object: ${data.picked_object || 'None'}, Year: ${data.dropped_year || 'None'}, State: ${data.current_state || 'main'}`, 'socket');
            updateCurrentState(data.picked_object, data.dropped_year, data.current_state);
        });

        socket.on('object_dropped', function(data) {
            addToLog('Object dropped/removed - application will return to main page', 'warning');
            updateCurrentState('None', 'None', 'main');
        });

        socket.on('arduino_ready', function(data) {
            addToLog('Arduino system is ready', 'success');
        });

        socket.on('system_reset', function(data) {
            addToLog('Arduino system reset complete', 'warning');
            updateCurrentState('None', 'None', 'main');
        });

        socket.on('arduino_disconnected', function(data) {
            addToLog('Arduino connection lost', 'error');
            arduinoStatus.textContent = 'Disconnected';
            arduinoStatus.style.color = '#dc3545';
        });

        // Arduino-specific event handlers
        socket.on('arduino_message', function(data) {
            addToLog(`Arduino: ${data.message}`, 'socket');
        });

        socket.on('unknown_rfid', function(data) {
            addToLog(`Unknown RFID detected: ${data.uid}`, 'warning');
        });

        socket.on('arduino_status', function(data) {
            const statusText = data.connected ? `Connected (${data.port})` : 'Disconnected';
            const statusColor = data.connected ? '#28a745' : '#dc3545';
            arduinoStatus.textContent = statusText;
            arduinoStatus.style.color = statusColor;
            addToLog(`Arduino status: ${statusText}`, data.connected ? 'success' : 'error');
        });

        socket.on('arduino_test_result', function(data) {
            const logType = data.success ? 'success' : 'error';
            addToLog(`Arduino test: ${data.message}`, logType);
        });

        // Control functions - Note: These are for testing UI behavior only
        // The actual main.py implementation only responds to real Arduino hardware
        function simulatePick() {
            const object = document.getElementById('objectSelect').value;
            if (!object) {
                alert('Please select an object first');
                return;
            }
            
            // Manually trigger the event that would come from Arduino
            addToLog(`Simulating object pick: ${object} (Note: Real implementation uses Arduino hardware)`, 'warning');
            socket.emit('object_picked', { object: object });
            updateCurrentState(object, null, 'section');
        }

        function simulateDrop() {
            const year = document.getElementById('yearSelect').value;
            const object = currentObject.textContent;
            if (!year) {
                alert('Please select a year range first');
                return;
            }
            if (!object || object === 'None') {
                alert('Please pick an object first');
                return;
            }
            
            // Manually trigger the event that would come from Arduino
            addToLog(`Simulating year drop: ${year} for ${object} (Note: Real implementation uses Arduino hardware)`, 'warning');
            socket.emit('year_dropped', { year: year, object: object });
            updateCurrentState(null, year, 'year-list');
        }

        function simulateObjectDrop() {
            addToLog('Simulating object removal (Note: Real implementation uses Arduino hardware)', 'warning');
            socket.emit('object_dropped', { message: "Object removed, returning to main page" });
            updateCurrentState('None', 'None', 'main');
        }

        function simulateYearRangeNotDetected() {
            addToLog('Note: Year range detection handled automatically by Arduino RFID system', 'info');
        }

        function simulateNoObjectDetected() {
            addToLog('Note: Object detection handled automatically by Arduino light sensors', 'info');
        }

        function resetSimulation() {
            addToLog('Resetting local simulation state (Note: Real Arduino system manages its own state)', 'warning');
            updateCurrentState('None', 'None', 'main');
        }

        function getStatus() {
            socket.emit('get_status');
            addToLog('Requesting system status', 'info');
        }

        function getArduinoStatus() {
            socket.emit('get_arduino_status');
            addToLog('Requesting Arduino status', 'info');
        }

        function testArduinoConnection() {
            socket.emit('test_arduino_connection');
            addToLog('Testing Arduino connection', 'info');
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // Initialize
        addToLog('Socket.IO test page loaded - Ready to monitor Arduino system');
    </script>
</body>
</html>
