<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Test & Arduino Monitor - NAF Object Recognition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .control-group {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button.reset { background-color: #dc3545; }
        button.reset:hover { background-color: #c82333; }
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .current-state {
            background-color: #e7f3ff;
            border: 1px solid #b6d7ff;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NAF Object Recognition - Socket.IO Test & Arduino Monitor</h1>
        
        <div id="connectionStatus" class="status disconnected">
            Disconnected
        </div>

        <div class="current-state">
            <h3>Current State</h3>
            <p><strong>Picked Object:</strong> <span id="currentObject">None</span></p>
            <p><strong>Dropped Year:</strong> <span id="currentYear">None</span></p>
            <p><strong>Current State:</strong> <span id="currentState">main</span></p>
            <p><strong>Arduino Status:</strong> <span id="arduinoStatus">Unknown</span></p>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Simulate Object Pick (Arduino Simulation)</h3>
                <select id="objectSelect">
                    <option value="">Select object...</option>
                    <option value="naf">NAF</option>
                    <option value="nafsfa">NAFSFA</option>
                    <option value="evol">EVOL</option>
                </select>
                <br>
                <button onclick="simulatePick()">Simulate Pick Object</button>
                <p><small>Simulates Arduino: "OBJECT_PICKED:[object]"</small></p>
            </div>

            <div class="control-group">
                <h3>Simulate Year Drop (Arduino Simulation)</h3>
                <select id="yearSelect">
                    <option value="">Select year range...</option>
                    <option value="1962-1971">1962-1971</option>
                    <option value="1972-1981">1972-1981</option>
                    <option value="1982-1991">1982-1991</option>
                    <option value="1992-2001">1992-2001</option>
                    <option value="2002-2011">2002-2011</option>
                    <option value="2012-2021">2012-2021</option>
                    <option value="2022-2031">2022-2031</option>
                </select>
                <br>
                <button onclick="simulateDrop()">Simulate Drop Year</button>
                <p><small>Simulates Arduino: "YEAR_DETECTED:[year]:[object]"</small></p>
            </div>
        </div>

        <div class="control-group" style="margin: 20px 0; text-align: center;">
            <h3>Arduino Controls</h3>
            <button onclick="getArduinoStatus()" style="background-color: #17a2b8;">Check Arduino Status</button>
            <button onclick="testArduinoConnection()" style="background-color: #28a745;">Test Arduino Connection</button>
        </div>

        <div class="control-group" style="margin: 20px 0; text-align: center;">
            <h3>Simulate Object Removal (Arduino Simulation)</h3>
            <button onclick="simulateObjectDrop()">Simulate Remove Object</button>
            <p><small>Simulates Arduino: "OBJECT_REMOVED:[object]"</small></p>
        </div>

        <div class="control-group" style="margin: 20px 0; text-align: center;">
            <h3>Additional Arduino Simulations</h3>
            <button onclick="simulateUnknownRFID()" style="background-color: #ffc107; color: #000;">Simulate Unknown RFID</button>
            <button onclick="simulateSystemReset()" style="background-color: #6c757d;">Simulate System Reset</button>
            <p><small>Test various Arduino scenarios</small></p>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="reset" onclick="resetSimulation()">Reset UI State</button>
            <button onclick="getStatus()">Get System Status</button>
        </div>

        <div>
            <h3>Socket Events Log</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
            <h3>Instructions</h3>
            <ol>
                <li>Start the Python server: <code>python main.py</code></li>
                <li><strong>Arduino Mode:</strong> Connect Arduino with RFID reader and light sensors for real hardware operation</li>
                <li><strong>Simulation Mode:</strong> Use the simulation controls above to test the complete system flow</li>
                <li>Monitor the socket events in the log below</li>
                <li>Test the main application at <a href="http://127.0.0.1:5550" target="_blank">127.0.0.1:5550</a></li>
            </ol>
            <h4>Hardware Setup:</h4>
            <ul>
                <li>Light sensors on A0 (NAF), A1 (NAFSFA), A2 (Evolution)</li>
                <li>RFID reader on pins 9 (RST) and 10 (SS)</li>
                <li>Configure SERIAL_PORT in .env file (e.g., /dev/cu.usbmodem101, COM3)</li>
                <li>Year ranges: 1962-1971, 1972-1981, 1982-1991, 1992-2001, 2002-2011, 2012-2021, 2022-2031</li>
            </ul>
            <h4>Simulation vs Real Hardware:</h4>
            <ul>
                <li><strong>Real Hardware:</strong> Arduino automatically detects objects via light sensors and years via RFID</li>
                <li><strong>Simulation Mode:</strong> Use simulation buttons to send the same data that Arduino would send</li>
                <li><strong>Server Logic:</strong> The main.py server processes both real Arduino data and simulated data identically</li>
                <li><strong>Testing Flow:</strong> 1) Pick object → 2) Drop year → 3) Remove object → 4) Reset</li>
            </ul>
        </div>
    </div>

    <script src="/assets/js/socket.io.min.js"></script>
    <script>
        const socket = io('http://127.0.0.1:5550');
        const log = document.getElementById('log');
        const connectionStatus = document.getElementById('connectionStatus');
        const currentObject = document.getElementById('currentObject');
        const currentYear = document.getElementById('currentYear');
        const currentState = document.getElementById('currentState');
        const arduinoStatus = document.getElementById('arduinoStatus');

        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${getColorForType(type)};">${message}</span>`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        function getColorForType(type) {
            switch(type) {
                case 'success': return '#28a745';
                case 'error': return '#dc3545';
                case 'warning': return '#ffc107';
                case 'socket': return '#007bff';
                default: return '#333';
            }
        }

        function updateCurrentState(object = null, year = null, state = null) {
            if (object !== null) currentObject.textContent = object || 'None';
            if (year !== null) currentYear.textContent = year || 'None';
            if (state !== null) currentState.textContent = state || 'main';
        }

        // Socket event handlers
        socket.on('connect', function() {
            connectionStatus.className = 'status connected';
            connectionStatus.textContent = 'Connected to server';
            addToLog('Connected to server', 'success');
            // Check Arduino status on connect
            getArduinoStatus();
        });

        socket.on('disconnect', function() {
            connectionStatus.className = 'status disconnected';
            connectionStatus.textContent = 'Disconnected from server';
            addToLog('Disconnected from server', 'error');
        });

        socket.on('status', function(data) {
            addToLog(`Server: ${data.msg}`, 'socket');
        });

        socket.on('error', function(data) {
            addToLog(`Error: ${data.msg}`, 'error');
        });

        socket.on('object_picked', function(data) {
            addToLog(`Object picked: ${data.object}`, 'success');
            updateCurrentState(data.object, null, 'section');
        });

        socket.on('year_dropped', function(data) {
            addToLog(`Year dropped: ${data.year} (Object: ${data.object})`, 'success');
            updateCurrentState(null, data.year, 'year-list');
        });

        socket.on('object_reset', function(data) {
            addToLog('Simulation reset', 'warning');
            updateCurrentState('None', 'None', 'main');
        });

        socket.on('system_status', function(data) {
            addToLog(`System Status - Object: ${data.picked_object || 'None'}, Year: ${data.dropped_year || 'None'}, State: ${data.current_state || 'main'}`, 'socket');
            updateCurrentState(data.picked_object, data.dropped_year, data.current_state);
        });

        socket.on('object_dropped', function(data) {
            addToLog('Object dropped/removed - application will return to main page', 'warning');
            updateCurrentState('None', 'None', 'main');
        });

        socket.on('arduino_ready', function(data) {
            addToLog('Arduino system is ready', 'success');
        });

        socket.on('system_reset', function(data) {
            addToLog('Arduino system reset complete', 'warning');
            updateCurrentState('None', 'None', 'main');
        });

        socket.on('arduino_disconnected', function(data) {
            addToLog('Arduino connection lost', 'error');
            arduinoStatus.textContent = 'Disconnected';
            arduinoStatus.style.color = '#dc3545';
        });

        // Arduino-specific event handlers
        socket.on('arduino_message', function(data) {
            addToLog(`Arduino: ${data.message}`, 'socket');
        });

        socket.on('unknown_rfid', function(data) {
            addToLog(`Unknown RFID detected: ${data.uid}`, 'warning');
        });

        socket.on('arduino_status', function(data) {
            const statusText = data.connected ? `Connected (${data.port})` : 'Disconnected';
            const statusColor = data.connected ? '#28a745' : '#dc3545';
            arduinoStatus.textContent = statusText;
            arduinoStatus.style.color = statusColor;
            addToLog(`Arduino status: ${statusText}`, data.connected ? 'success' : 'error');
        });

        socket.on('arduino_test_result', function(data) {
            const logType = data.success ? 'success' : 'error';
            addToLog(`Arduino test: ${data.message}`, logType);
        });

        socket.on('simulation_result', function(data) {
            const logType = data.success ? 'success' : 'error';
            addToLog(`Simulation: ${data.message}`, logType);
        });

        socket.on('rfid_detected', function(data) {
            addToLog(`RFID detected: ${data.uid} for object: ${data.object}`, 'socket');
            // For simulation, we need to handle the RFID mapping here
            // In a real app, this would be handled by rfid-year-mapping.js
            simulateRFIDMapping(data.uid, data.object);
        });

        socket.on('year_resolution_result', function(data) {
            const logType = data.success ? 'success' : 'error';
            addToLog(`Year resolution: ${data.message}`, logType);
        });

        // Control functions - These now properly simulate Arduino input to main.py
        function simulatePick() {
            const object = document.getElementById('objectSelect').value;
            if (!object) {
                alert('Please select an object first');
                return;
            }
            
            addToLog(`Sending simulate_object_picked: ${object}`, 'info');
            socket.emit('simulate_object_picked', { object: object });
        }

        function simulateDrop() {
            const year = document.getElementById('yearSelect').value;
            if (!year) {
                alert('Please select a year range first');
                return;
            }
            
            // Generate a fake RFID UID for the selected year
            const uid = generateFakeRFIDForYear(year);
            
            addToLog(`Sending simulate_rfid_uid: ${uid} for year: ${year}`, 'info');
            socket.emit('simulate_rfid_uid', { uid: uid });
        }

        function generateFakeRFIDForYear(yearRange) {
            // Create a simple mapping for simulation
            const yearToUID = {
                '1962-1971': '04A1B2C3',
                '1972-1981': '04D4E5F6',
                '1982-1991': '04A7B8C9',
                '1992-2001': '04D0E1F2',
                '2002-2011': '04A3B4C5',
                '2012-2021': '04D6E7F8',
                '2022-2031': '04A9B0C1'
            };
            return yearToUID[yearRange] || `SIM-${Math.random().toString(36).substr(2, 8).toUpperCase()}`;
        }

        function simulateRFIDMapping(uid, object) {
            // Simple RFID to year mapping for simulation
            const uidToYear = {
                '04A1B2C3': '1962-1971',
                '04D4E5F6': '1972-1981',
                '04A7B8C9': '1982-1991',
                '04D0E1F2': '1992-2001',
                '04A3B4C5': '2002-2011',
                '04D6E7F8': '2012-2021',
                '04A9B0C1': '2022-2031'
            };
            
            const yearRange = uidToYear[uid];
            if (yearRange) {
                addToLog(`RFID mapping: ${uid} → ${yearRange}`, 'success');
                // Send the resolved year back to the server
                socket.emit('resolve_year_from_rfid', {
                    uid: uid,
                    year_range: yearRange,
                    object: object
                });
            } else {
                addToLog(`Unknown RFID UID: ${uid}`, 'error');
                socket.emit('simulate_unknown_rfid', { uid: uid });
            }
        }

        function simulateObjectDrop() {
            addToLog('Sending simulate_object_removed', 'info');
            socket.emit('simulate_object_removed', {});
        }

        function simulateUnknownRFID() {
            const uid = `TEST-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
            addToLog(`Sending simulate_unknown_rfid: ${uid}`, 'info');
            socket.emit('simulate_unknown_rfid', { uid: uid });
        }

        function simulateSystemReset() {
            addToLog('Sending simulate_system_reset', 'info');
            socket.emit('simulate_system_reset', {});
        }

        function resetSimulation() {
            addToLog('Sending simulate_system_reset to reset state', 'info');
            socket.emit('simulate_system_reset', {});
        }

        function getStatus() {
            socket.emit('get_status');
            addToLog('Requesting system status', 'info');
        }

        function getArduinoStatus() {
            socket.emit('get_arduino_status');
            addToLog('Requesting Arduino status', 'info');
        }

        function testArduinoConnection() {
            socket.emit('test_arduino_connection');
            addToLog('Testing Arduino connection', 'info');
        }

        function clearLog() {
            log.innerHTML = '';
        }

        // Initialize
        addToLog('Socket.IO test page loaded - Ready to simulate Arduino system or monitor real hardware');
    </script>
</body>
</html>
